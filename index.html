<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Belarus District Quiz</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <style>
        html, body {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
        }
        #map {
            height: 100vh;
            width: 100vw;
        }
        #loading-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: white;
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 2000;
            font-size: 24px;
            font-weight: bold;
        }
        #selection-box {
            position: absolute;
            top: 20%;
            left: 50%;
            transform: translateX(-50%);
            background-color: white;
            padding: 20px;
            border: 1px solid #ccc;
            border-radius: 10px;
            box-shadow: 0 0 15px rgba(0, 0, 0, 0.2);
            z-index: 1000;
        }
        #prompt-box, #message-box, #count-box {
            position: absolute;
            background-color: white;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 5px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
            z-index: 1000;
        }
        #prompt-box {
            top: 10px;
            left: 50%;
            transform: translateX(-50%);
        }
        #message-box {
            top: 60px;
            left: 50%;
            transform: translateX(-50%);
            opacity: 0;
            transition: opacity 0.3s;
        }
        #count-box {
            top: 10px;
            left: 10px;
        }
        .region-option {
            margin-bottom: 5px;
        }
        #start-button {
            margin-top: 20px;
        }
        #endgame-box {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: rgba(255, 255, 255, 1);
            padding: 40px;
            border-radius: 10px;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.3);
            text-align: center;
            width: 50%;
            max-width: 600px;
            z-index: 1000;
        }
        #endgame-box h1 {
            font-size: 24px;
            margin-bottom: 20px;
        }
        #endgame-box .score {
            font-size: 32px;
            font-weight: bold;
            margin-bottom: 20px;
        }
        #restart-button {
            padding: 10px 20px;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 5px;
            font-size: 18px;
            cursor: pointer;
        }
        #restart-button:hover {
            background-color: #45a049;
        }
    </style>
</head>
<body>
    <div id="loading-screen">Загрузка...</div>
    <div id="map"></div>
    <div id="selection-box">
        <form id="region-form">
            <label>
                <input type="checkbox" id="whole-country" value="Уся краіна">
                Уся краіна
            </label><br>
            <label>
                <input type="checkbox" id="minsk-region" value="Мінская вобласць" class="region-option">
                Мінская вобласць
            </label><br>
            <label>
                <input type="checkbox" id="vitebsk-region" value="Віцебская вобласць" class="region-option">
                Віцебская вобласць
            </label><br>
            <label>
                <input type="checkbox" id="grodno-region" value="Гродзенская вобласць" class="region-option">
                Гродзенская вобласць
            </label><br>
            <label>
                <input type="checkbox" id="brest-region" value="Брэсцкая вобласць" class="region-option">
                Брэсцкая вобласць
            </label><br>
            <label>
                <input type="checkbox" id="mogilev-region" value="Магілёўская вобласць" class="region-option">
                Магілёўская вобласць
            </label><br>
            <label>
                <input type="checkbox" id="gomel-region" value="Гомельская вобласць" class="region-option">
                Гомельская вобласць
            </label><br>
            <button type="button" id="start-button">Пачаць квіз</button>
        </form>        
    </div>
    <div id="prompt-box"></div>
    <div id="message-box"></div>
    <div id="count-box"></div>
    <div id="endgame-box" style="display: none;">
        <h1>Квіз завершаны</h1>
        <div class="score"></div>
        <button id="restart-button">Пачаць зноў</button>
    </div>
    <script>
        let map, districtsGeoJson, regionsGeoJson, countriesGeoJson, targetDistrict, attempts, totalDistricts, remainingDistricts = [], filledInDistricts = 0, score = 0;

        // Initialize map
        map = L.map('map', {
            center: [53.9, 27.5667], // Center of Belarus
            zoom: 6.8,
            zoomSnap: 0.1,
            zoomControl: false,
            scrollWheelZoom: false,
            doubleClickZoom: false,
            dragging: false,
            boxZoom: false,
            keyboard: false,
            touchZoom: false,
        });

        // Tile layer
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '© OpenStreetMap contributors'
        }).addTo(map);

        Promise.all([
            fetch('regions.geojson').then(res => res.json()),
            fetch('districts.geojson').then(res => res.json()),
            fetch('countries.geojson').then(res => res.json())
        ])
        .then(([regionsData, districtsData, countriesData]) => {
            regionsGeoJson = regionsData;

            districtsGeoJson = L.geoJSON(districtsData, {
                style: { color: '#000', weight: 0.5, fillOpacity: 0, fillColor: '#ffffff' },
                interactive: true,
                onEachFeature: onEachDistrict
            }).addTo(map);

            // Add regions to a separate pane with z-index 650
            regionsGeoJsonMap = L.geoJSON(regionsData, {
                style: { color: '#000', weight: 1.4, fillOpacity: 1, fillColor: '#eeeeee' },
                interactive: false
            }).addTo(map);

            countriesGeoJson = L.geoJSON(countriesData, {
                style: { color: '#000', weight: 2, fillOpacity: 1, fillColor: '#ccc' },
                interactive: false
            }).addTo(map);

            // Listen for map to complete loading
            map.whenReady(() => {
                document.getElementById('loading-screen').style.display = 'none'; // Remove loading screen
                document.getElementById('start-button').disabled = false;        // Enable start button
            });
        })
        .catch(error => console.error("Error loading GeoJSON data:", error));
        // Function to adjust the UI based on the screen orientation
        function adjustForOrientation() {
            const isMobileOrTablet = window.innerWidth <= 1024;  // Check if the screen is small (mobile or tablet)

            if (isMobileOrTablet) {
                if (window.innerWidth > window.innerHeight) {  // Landscape mode
                    // For landscape on mobile/tablet, keep default zoom and don't rescale UI
                    map.setZoom(6.2); // Adjust zoom level for landscape mode on small screens
                    resetUI(); // Reset the UI to default size
                } else {  // Portrait mode
                    // For portrait on mobile/tablet, increase zoom and scale UI
                    map.setZoom(7);  // Adjust zoom level for portrait mode on small screens
                    scaleUI(); // Increase the size of UI elements by 40%
                }
            } else {
                // For laptops/desktops, keep default zoom and UI
                map.setZoom(6.8);  // Default zoom level
                resetUI();  // Reset UI elements to their default size
            }
        }

        // Function to adjust the UI based on the screen orientation and screen size
        function adjustForOrientation() {
            const isMobileOrTablet = window.innerWidth <= 1024;  // Check if the screen is small (mobile or tablet)

            // Center the selection box
            document.getElementById('selection-box').style.left = '50%';  // Horizontally centered
            document.getElementById('selection-box').style.top = '20%';   // Default vertical position

            if (isMobileOrTablet) {
                if (window.innerWidth > window.innerHeight) {  // Landscape mode
                    // For landscape on mobile/tablet, keep default zoom and don't rescale UI
                    map.setZoom(6.2); // Adjust zoom level for landscape mode on small screens
                    resetUI(); // Reset the UI to default size
                } else {  // Portrait mode
                    // For portrait on mobile/tablet, increase zoom and scale UI
                    map.setZoom(7);  // Adjust zoom level for portrait mode on small screens
                    scaleUI(); // Increase the size of UI elements by 40%
                }
            } else {
                // For laptops/desktops, keep default zoom and UI
                map.setZoom(6.8);  // Default zoom level
                resetUI();  // Reset UI elements to their default size
            }
        }

        // Function to scale up the UI elements by 40% (for portrait on small screens)
        function scaleUI() {
            // Increase the size of selection box and text without scaling the box itself
            document.querySelectorAll('#selection-box, #prompt-box, #message-box, #count-box').forEach(element => {
                element.style.fontSize = '22px';  // Increase font size by 40%
                element.style.padding = '28px';  // Increase padding by 40%
            });
        }

        // Function to reset the UI elements to their default size (for landscape and desktop)
        function resetUI() {
            document.querySelectorAll('#selection-box').forEach(element => {
                element.style.fontSize = '16px';  // Default font size
                element.style.padding = '20px';  // Default padding
            });
            // Reset the font size and padding to default values
            document.querySelectorAll('#prompt-box, #message-box, #count-box').forEach(element => {
                element.style.fontSize = '16px';  // Default font size
                element.style.padding = '10px';  // Default padding
            });
        }

        // Call adjustForOrientation on window resize and orientation change events
        window.addEventListener('resize', adjustForOrientation);
        window.addEventListener('orientationchange', adjustForOrientation);

        // Initialize adjustments on page load
        adjustForOrientation();


        document.getElementById('whole-country').addEventListener('change', function () {
            const regionOptions = document.querySelectorAll('.region-option');
            regionOptions.forEach(option => option.disabled = this.checked);
            if (this.checked) {
                regionOptions.forEach(option => {
                    option.checked = false;
                });
            }
        });

        function onEachDistrict(feature, layer) {
            layer.on('click', () => checkAnswer(feature.properties.name, layer));
        }

        L.Layer.prototype.setInteractive = function (interactive) {
            if (this.getLayers) {
                this.getLayers().forEach(layer => {
                    layer.setInteractive(interactive);
                });
                return;
            }
            if (!this._path) {
                return;
            }

            this.options.interactive = interactive;

            if (interactive) {
                L.DomUtil.addClass(this._path, 'leaflet-interactive');
            } else {
                L.DomUtil.removeClass(this._path, 'leaflet-interactive');
            }
        };

        function enableDistricts(selectedRegions, selectedDistricts) {
            // Adjust opacity for selected regions and make them non-interactive
            regionsGeoJsonMap.eachLayer(layer => {
                if (selectedRegions.includes(layer.feature.properties.name)) {
                    layer.setStyle({ fillOpacity: 0 }); // Hide region
                }
            });

            // Enable visibility and interactivity for selected districts
            districtsGeoJson.eachLayer(layer => {
                if (selectedDistricts.includes(layer.feature.properties.name)) {
                    layer.setStyle({ fillOpacity: 1, fillColor: '#ffffff' }); // Show district                  
                }
                else {
                    layer.setInteractive(false);
                }
            });
        }


        document.getElementById('start-button').addEventListener('click', () => {
            const selectedRegions = Array.from(document.querySelectorAll('#region-form input:checked')).map(input => input.value);
            if (selectedRegions.includes("Уся краіна")) {
                selectedRegions.splice(0, selectedRegions.length, ...regionsGeoJson.features.map(f => f.properties.name));
            }
            const selectedDistricts = [];
            regionsGeoJson.features.forEach(region => {
                if (selectedRegions.includes(region.properties.name)) {
                    selectedDistricts.push(...region.properties.districts);
                }
            });

            enableDistricts(selectedRegions, selectedDistricts);

            remainingDistricts = selectedDistricts.sort(() => Math.random() - 0.5);
            totalDistricts = remainingDistricts.length;
            updateCountBox();
            nextDistrict();
            document.getElementById('selection-box').style.display = 'none';
        });

        function checkAnswer(clickedDistrictName, layer) {
            if (clickedDistrictName === targetDistrict) {
                let fillColor;
                if (attempts === 3) fillColor = 'lightgreen';
                else if (attempts === 2) fillColor = '#effd5f';
                else fillColor = '#fdce2a';

                score += attempts / 3;
                layer.setStyle({ fillColor, fillOpacity: 1 });
                filledInDistricts++;
                updateMessage('Правільна!');
                updateCountBox();
                setTimeout(nextDistrict, 1300);
            } else {
                attempts--;
                if (attempts > 0) {
                    updateMessage(`Паспрабуй яшчэ! Ты выбраў: ${clickedDistrictName}. Спроб: ${attempts}`);
                } else {
                    updateMessage(`Спроб няма! Ты выбраў: ${clickedDistrictName}`);
                    districtsGeoJson.eachLayer(l => {
                        if (l.feature.properties.name === targetDistrict) {
                            blinkDistrict(l)
                        }
                    });
                    filledInDistricts++;
                    setTimeout(nextDistrict, 1500);
                }
            }
        }

        function blinkDistrict(layer) {
            const totalDuration = 1200; // Total blinking duration in milliseconds
            const totalBlinks = 3; // Total number of blinks
            const intervalTime = totalDuration / (totalBlinks * 2); // Time for each blink phase (on or off)

            let blinkCount = 0;
            const interval = setInterval(() => {
                // Toggle opacity: even counts are full opacity, odd counts are dimmed
                layer.setStyle({ fillOpacity: blinkCount % 2 ? 0.5 : 1, fillColor: '#f08080' });
                blinkCount++;
                if (blinkCount >= totalBlinks * 2) { // Total phases are twice the number of blinks
                    clearInterval(interval);
                    // Ensure the final state is fully opaque
                    layer.setStyle({ fillOpacity: 1, fillColor: '#f08080' });
                }
            }, intervalTime);
        }



        function nextDistrict() {
            if (filledInDistricts < totalDistricts) {
                targetDistrict = remainingDistricts.pop();
                attempts = 3;
                document.getElementById('prompt-box').innerText = `Шукаем: ${targetDistrict}`;
                updateCountBox();
            } else {
                showEndGame();
            }
        }

        function showEndGame() {
            const percentageScore = ((score / totalDistricts) * 100).toFixed(1);
            document.querySelector('#endgame-box .score').innerText = `Твой лік: ${percentageScore}%`;
            document.getElementById('endgame-box').style.display = 'block';

            map.eachLayer(layer => {
                layer.off();
            });

            document.getElementById('restart-button').addEventListener('click', () => location.reload());
        }


        function updateCountBox() {
            document.getElementById('count-box').innerText = `Запоўнена: ${filledInDistricts} з ${totalDistricts}`;
        }

        function updateMessage(message) {
            const messageBox = document.getElementById('message-box');
            messageBox.innerText = message;
            messageBox.style.opacity = 1;
            setTimeout(() => { messageBox.style.opacity = 0; }, 3000);
        }
    </script>
</body>
</html>
